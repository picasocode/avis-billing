<!DOCTYPE html>
<html lang="en" class="h-full bg-white dark:bg-gray-900">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Login - Avis Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <style>
        /* Responsive fade-in-up animation */
        @keyframes fade-in-up {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fade-in-up 0.6s ease-out forwards;
        }

        /* Dark mode shadow */
        .dark .shadow-2xl {
            --tw-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            box-shadow: var(--tw-shadow);
        }

        /* Custom font */
        body {
            font-family: "Roboto Mono", monospace;
            font-optical-sizing: auto;
        }
    </style>
</head>

<body class="bg-white dark:bg-gray-900 antialiased flex flex-col items-center justify-center min-h-screen p-4 transition-colors duration-300">

    <div class="mb-8 text-center">
        <a href="#">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-16 w-auto mx-auto text-[#223C4A] dark:text-gray-200">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-6 2a.75.75 0 01.75-.75h14.25a.75.75 0 01.75.75v6.75a.75.75 0 01-.75.75H2.25a.75.75 0 01-.75-.75v-6.75z" />
            </svg>
        </a>
        <p class="mt-2 text-sm text-[#223C4A] dark:text-gray-300 font-light tracking-widest uppercase">Building a Better Tech</p>
    </div>

    <div class="w-full max-w-sm mx-auto bg-gray-100 dark:bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 animate-fade-in-up">
        <div class="text-center">
            <h1 class="text-3xl font-extrabold text-[#223C4A] dark:text-gray-100 tracking-tight">Shop Owner / Staff Login</h1>
            <p id="form-subtitle" class="mt-2 text-sm text-gray-500 dark:text-gray-400">Enter your phone number to receive an OTP</p>
        </div>

        <form id="otpSendForm" class="mt-6 space-y-5">
            <div>
                <label for="phone-send" class="sr-only">Phone Number</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.183.448l-.905 1.254a1.125 1.125 0 01-1.458.0L9.917 9.389A3.588 3.588 0 0112 5.25a3.588 3.588 0 015.084 1.458l1.254-.905a1.125 1.125 0 00.448-1.183l-1.106-4.423A2.25 2.25 0 0018.75 3h-1.372C9.716 3 2.25 9.716 2.25 18v2.25a2.25 2.25 0 002.25 2.25h1.372c.516 0 .966-.351 1.091-.852l1.106-4.423c.11-.44-.055-.902-.448-1.183l-1.254-.905a1.125 1.125 0 01-.0-1.458L9.389 9.917c.393-.281.558-.743.448-1.183l-1.106-4.423a2.25 2.25 0 00-1.091-.852V3.75z" />
                        </svg>
                    </div>
                    <input id="phone-send" name="phone" type="text" autocomplete="tel" required
                        class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm"
                        placeholder="Phone Number (e.g., +919876543210)">
                </div>
            </div>
            <div>
                <button type="submit" id="send-otp-button"
                    class="group relative flex justify-center w-full py-2.5 px-4 border border-transparent text-sm font-semibold rounded-lg text-white bg-[#D13F0B] hover:bg-[#b23308] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#D13F0B] dark:focus:ring-offset-gray-800 transition-all duration-300 transform active:scale-95">
                    <span id="send-button-text">Send OTP</span>
                    <span id="send-button-spinner" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
                        <svg class="w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </form>

        <form id="otpVerifyForm" class="hidden mt-6 space-y-5">
            <div>
                <label for="phone-verify" class="sr-only">Phone Number</label>
                <input id="phone-verify" name="phone" type="text" autocomplete="tel" required readonly
                    class="relative block w-full px-4 py-2.5 text-gray-900 dark:text-white placeholder-gray-500 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-not-allowed sm:text-sm">
            </div>
            <div>
                <label for="otp" class="sr-only">OTP</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3v2.25m-3-3h-2.25m-3 3h-2.25m-3-3V8.25m3 3V12m-3-3h-2.25M6.75 12h-2.25m3-3h-2.25m-3 3v2.25m3-3v2.25m-3 3V12m6.75 3v2.25m-3-3h-2.25m-3 3h-2.25m-3-3V12m3 3v2.25m-3 3V12m6.75 3v2.25M15.75 12V8.25m3 3h2.25m-3-3h-2.25m-3 3V12m3 3V12m3 3h2.25m-3-3h-2.25m-3 3v2.25m3 3v2.25m-3 3V12m6.75 3v2.25" />
                        </svg>
                    </div>
                    <input id="otp" name="otp" type="text" required
                        class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm"
                        placeholder="Enter the 6-digit OTP">
                </div>
            </div>
            <div>
                <button type="submit" id="verify-otp-button"
                    class="group relative flex justify-center w-full py-2.5 px-4 border border-transparent text-sm font-semibold rounded-lg text-white bg-[#D13F0B] hover:bg-[#b23308] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#D13F0B] dark:focus:ring-offset-gray-800 transition-all duration-300 transform active:scale-95">
                    <span id="verify-button-text">Verify OTP</span>
                    <span id="verify-button-spinner" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
                        <svg class="w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
            <p class="text-sm text-center">
                <a href="#" id="change-number" class="font-medium text-[#223C4A] dark:text-gray-300 hover:text-[#D13F0B] transition-colors duration-200">Change Number</a> | Didn't receive the OTP? <a href="#" id="resend-otp" class="font-medium text-[#D13F0B] hover:text-[#b23308] transition-colors duration-200">Resend OTP</a>
            </p>
        </form>

        <div id="status-message" class="mt-4 text-center text-sm font-medium"></div>

        <div id="result-container" class="mt-6">
            <pre id="result" class="hidden w-full p-4 overflow-auto text-sm text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 transition-all duration-300"></pre>
        </div>
    </div>

    <footer class="mt-8 text-gray-500 dark:text-gray-500 text-sm">
        &copy; 2025 Avis Technologies. All rights reserved.
    </footer>

    <script>
        const otpSendForm = document.getElementById("otpSendForm");
        const otpVerifyForm = document.getElementById("otpVerifyForm");
        const statusElement = document.getElementById("status-message");
        const phoneSendInput = document.getElementById("phone-send");
        const phoneVerifyInput = document.getElementById("phone-verify");
        const formSubtitle = document.getElementById("form-subtitle");
        const sendOtpButton = document.getElementById("send-otp-button");
        const verifyOtpButton = document.getElementById("verify-otp-button");
        const resendButton = document.getElementById("resend-otp");
        const changeNumberButton = document.getElementById("change-number");

        let timer; // Declare timer globally to be accessible for stopping

        function setButtonLoading(button, text, isLoading) {
            const buttonText = button.querySelector('span:not([id$="-spinner"])');
            const buttonSpinner = button.querySelector('span[id$="-spinner"]');

            if (buttonText && buttonSpinner) {
                button.disabled = isLoading;
                button.classList.toggle('cursor-not-allowed', isLoading);
                button.classList.toggle('opacity-75', isLoading);
                buttonText.textContent = isLoading ? text : button.dataset.originalText;
                buttonSpinner.classList.toggle('hidden', !isLoading);
            } else {
                console.error("Button elements not found for:", button);
            }
        }

        // Store original button text
        sendOtpButton.dataset.originalText = "Send OTP";
        verifyOtpButton.dataset.originalText = "Verify OTP";

        otpSendForm.onsubmit = async function(e) {
            e.preventDefault();
            const phone = phoneSendInput.value;
            statusElement.textContent = "";
            setButtonLoading(sendOtpButton, "Sending...", true);

            try {
                const response = await fetch("/accounts/api/send-otp/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        phone
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    statusElement.textContent = "OTP sent successfully! Please enter the code below.";
                    statusElement.className = "mt-4 text-center text-sm font-medium text-green-600 dark:text-green-400";
                    otpSendForm.classList.add("hidden");
                    otpVerifyForm.classList.remove("hidden");
                    phoneVerifyInput.value = phone;
                    formSubtitle.textContent = "A 6-digit code has been sent to your phone number.";

                    // Start resend timer
                    let countdown = 60;
                    resendButton.disabled = true;
                    resendButton.textContent = `Resend OTP (${countdown}s)`;
                    timer = setInterval(() => {
                        countdown--;
                        resendButton.textContent = `Resend OTP (${countdown}s)`;
                        if (countdown <= 0) {
                            clearInterval(timer);
                            resendButton.disabled = false;
                            resendButton.textContent = "Resend OTP";
                        }
                    }, 1000);
                } else {
                    statusElement.textContent = data.message || data.error || "Failed to send OTP. Please try again.";
                    statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                }
            } catch (error) {
                statusElement.textContent = "An unexpected network error occurred. Please try again.";
                statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                console.error("OTP Send Error:", error);
            } finally {
                setButtonLoading(sendOtpButton, "Send OTP", false);
            }
        };

        otpVerifyForm.onsubmit = async function(e) {
            e.preventDefault();
            const phone = phoneVerifyInput.value;
            const otp = document.getElementById("otp").value;
            statusElement.textContent = "";
            setButtonLoading(verifyOtpButton, "Verifying...", true);

            try {
                const response = await fetch("/accounts/api/verify-otp/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        phone,
                        otp
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Save tokens and user
                    if (data.access) localStorage.setItem("access", data.access);
                    if (data.refresh) localStorage.setItem("refresh", data.refresh);
                    if (data.user) localStorage.setItem("user", JSON.stringify(data.user));

                    // Choose redirect (backend-provided redirect_url takes priority)
                    const fallbackSetup = "/business/setup-form/";
                    const fallbackDashboard = "/dashboard/";
                    const redirectUrl = data.redirect_url || (data.needs_setup ? fallbackSetup : fallbackDashboard);

                    statusElement.textContent = "Verification successful! Redirecting…";
                    statusElement.className = "mt-4 text-center text-sm font-medium text-green-600 dark:text-green-400";

                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 800);
                } else {
                    statusElement.textContent = data.message || data.error || "Invalid OTP. Please try again.";
                    statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                }
            } catch (error) {
                statusElement.textContent = "An unexpected network error occurred. Please check your connection.";
                statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                console.error("OTP Verify Error:", error);
            } finally {
                setButtonLoading(verifyOtpButton, "Verify OTP", false);
            }
        };

        resendButton.onclick = async function(e) {
            e.preventDefault();
            const phone = phoneVerifyInput.value;
            resendButton.disabled = true;
            resendButton.textContent = "Sending...";
            statusElement.textContent = "";
            clearInterval(timer);

            try {
                const response = await fetch("/accounts/api/send-otp/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        phone
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    statusElement.textContent = "OTP resent successfully!";
                    statusElement.className = "mt-4 text-center text-sm font-medium text-green-600 dark:text-green-400";

                    // Restart resend timer
                    let countdown = 60;
                    resendButton.textContent = `Resend OTP (${countdown}s)`;
                    timer = setInterval(() => {
                        countdown--;
                        resendButton.textContent = `Resend OTP (${countdown}s)`;
                        if (countdown <= 0) {
                            clearInterval(timer);
                            resendButton.disabled = false;
                            resendButton.textContent = "Resend OTP";
                        }
                    }, 1000);
                } else {
                    statusElement.textContent = data.message || "Failed to resend OTP.";
                    statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                }
            } catch (error) {
                statusElement.textContent = "An error occurred while trying to resend.";
                statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                console.error("Resend Error:", error);
            }
        };

        changeNumberButton.onclick = function(e) {
            e.preventDefault();
            otpVerifyForm.classList.add("hidden");
            otpSendForm.classList.remove("hidden");
            phoneSendInput.value = "";
            document.getElementById("otp").value = "";
            formSubtitle.textContent = "Enter your phone number to receive an OTP";
            statusElement.textContent = "";
            clearInterval(timer);
            resendButton.disabled = false;
            resendButton.textContent = "Resend OTP";
        };
    </script>
</body>

</html>