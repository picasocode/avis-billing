<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100 dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@100..700&display=swap" rel="stylesheet">
    <style>
        /* A simple animation for the main content card */
        @keyframes fade-in-up {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fade-in-up 0.6s ease-out forwards;
        }

        /* Dark mode adjustments for card shadow */
        .dark .shadow-2xl {
            --tw-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --tw-shadow-colored: 0 25px 50px -12px var(--tw-shadow-color);
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
        }

        /* Custom properties for Roboto Mono */
        :root {
            --font-mono: 'Roboto Mono', monospace;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 font-mono antialiased flex items-center justify-center min-h-screen p-4 transition-colors duration-300">
    <div class="w-full max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 animate-fade-in-up transition-all duration-300 ease-in-out transform hover:scale-[1.02] active:scale-100 font-mono">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-[#223C4A] dark:text-gray-100 tracking-tight">Complete Your Business Profile</h1>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">This information is required to continue using Avis Billing.</p>
        </div>

        <form id="businessForm" class="space-y-5">
            <div>
                <label for="business_name" class="sr-only">Business/Shop Name</label>
                <input type="text" id="business_name" name="business_name" placeholder="Business/Shop Name"
                    class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm" required>
            </div>
            <div>
                <label for="phone_number" class="sr-only">Phone Number</label>
                <input type="text" id="phone_number" name="phone_number" placeholder="Phone Number"
                    class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm" required>
            </div>
            <div>
                <label for="gst_number" class="sr-only">GST Number (Optional)</label>
                <input type="text" id="gst_number" name="gst_number" placeholder="GST Number (Optional)"
                    class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm">
            </div>
            <div>
                <label for="billing_address" class="sr-only">Billing Address</label>
                <textarea id="billing_address" name="billing_address" placeholder="Billing Address"
                    class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm"></textarea>
            </div>
            <div>
                <h2 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Bank Details (Optional)</h2>
                <div class="space-y-3">
                    <input type="text" name="bank_name" placeholder="Bank Name"
                        class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm">
                    <input type="text" name="account_number" placeholder="Account Number"
                        class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm">
                    <input type="text" name="ifsc_code" placeholder="IFSC Code"
                        class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-[#D13F0B] focus:border-[#D13F0B] sm:text-sm">
                </div>
            </div>

            <div>
                <button type="submit" id="save-button"
                    class="group relative flex justify-center w-full py-2.5 px-4 border border-transparent text-sm font-semibold rounded-lg text-white bg-[#D13F0B] hover:bg-[#b23308] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#D13F0B] dark:focus:ring-offset-gray-800 transition-all duration-300 transform active:scale-95">
                    <span id="button-text">Save & Continue</span>
                    <span id="button-spinner" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
                        <svg class="w-5 h-5 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </form>

        <div id="status-message" class="mt-4 text-center text-sm font-medium"></div>
        <pre id="result" class="hidden mt-4 p-4 overflow-auto text-sm text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 transition-all duration-300"></pre>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const businessForm = document.getElementById("businessForm");
            const saveButton = document.getElementById("save-button");
            const buttonText = document.getElementById("button-text");
            const buttonSpinner = document.getElementById("button-spinner");
            const resultElement = document.getElementById("result");
            const statusElement = document.getElementById("status-message");

            businessForm.onsubmit = async function(e) {
                e.preventDefault();

                // Show loading state
                saveButton.disabled = true;
                saveButton.classList.add('cursor-not-allowed', 'opacity-75');
                buttonText.textContent = "Saving...";
                buttonSpinner.classList.remove("hidden");
                statusElement.textContent = "Processing your business profile...";
                statusElement.className = "mt-4 text-center text-sm font-medium text-gray-600 dark:text-gray-400";
                resultElement.classList.add("hidden");

                const data = Object.fromEntries(new FormData(e.target).entries());
                const token = localStorage.getItem("access");

                try {
                    const response = await fetch("/business/setup/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": token ? ("Bearer " + token) : ""
                        },
                        body: JSON.stringify(data)
                    });

                    const json = await response.json();

                    if (response.ok) {
                        statusElement.textContent = "Business profile saved successfully! Redirecting...";
                        statusElement.className = "mt-4 text-center text-sm font-medium text-green-600 dark:text-green-400";
                        setTimeout(() => window.location.href = "/dashboard/", 1500);
                    } else {
                        statusElement.textContent = json.message || "Failed to save profile. Please check the details.";
                        statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                        resultElement.textContent = JSON.stringify(json, null, 2);
                        resultElement.classList.remove("hidden");
                    }

                } catch (error) {
                    statusElement.textContent = "An unexpected network error occurred. Please try again.";
                    statusElement.className = "mt-4 text-center text-sm font-medium text-red-600 dark:text-red-400";
                    console.error("Business Setup Error:", error);
                } finally {
                    // Revert loading state
                    saveButton.disabled = false;
                    saveButton.classList.remove('cursor-not-allowed', 'opacity-75');
                    buttonText.textContent = "Save & Continue";
                    buttonSpinner.classList.add("hidden");
                }
            };
        });
    </script>
</body>
</html>